services:
  # Unit tests for config server
  configserver-test:
    build:
      context: ./configserver
      target: test
    container_name: cs_configserver_test
    command: pytest tests/ -v --cov=app --cov-report=term --cov-report=xml --cov-report=html
    volumes:
      - ./configserver/tests:/app/tests
      - ./configserver/coverage:/app/coverage
    environment:
      - PYTHONUNBUFFERED=1

  # Config server for integration tests
  configserver:
    build:
      context: ./configserver
      target: production
    container_name: cs_configserver_integration
    environment:
      - FLASK_ENV=production
    ports:
      - "8080:8080"
    volumes:
      - ./data:/data
    networks:
      - containerssh_net

  # ContainerSSH gateway for integration tests
  containerssh:
    image: containerssh/containerssh:v0.5.2
    container_name: containerssh_integration
    depends_on:
      - configserver
      - vm1
      - vm2
    ports:
      - "2222:2222"
    environment:
      - CONTAINERSSH_CONFIG=/etc/containerssh/config.yaml
    volumes:
      - ./containerssh/config.yaml:/etc/containerssh/config.yaml:ro
      - ./containerssh/keys:/etc/containerssh/keys:ro
      - ./data/known_hosts:/etc/containerssh/known_hosts:ro
    networks:
      - containerssh_net

  # Mock backend VM 1 for integration tests
  vm1:
    build: ./backend-vms
    container_name: backend_vm1_test
    hostname: vm1
    environment:
      - VM_NAME=vm1
    networks:
      - containerssh_net

  # Mock backend VM 2 for integration tests
  vm2:
    build: ./backend-vms
    container_name: backend_vm2_test
    hostname: vm2
    environment:
      - VM_NAME=vm2
    networks:
      - containerssh_net

networks:
  containerssh_net:
    driver: bridge
